<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロジェクト管理 - レシートキャンペーンCMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- コンポーネント化されたナビゲーション -->
    </div>

    <!-- 新規プロジェクト作成モーダル -->
    <div id="create-project-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">新規プロジェクト作成</h3>
                <form id="create-project-form" class="space-y-4">
                    <div>
                        <label for="project-name" class="block text-sm font-medium text-gray-700">プロジェクト名</label>
                        <input type="text" id="project-name" name="projectName" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700">クライアント名</label>
                        <input type="text" id="client-name" name="clientName" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="client-email" class="block text-sm font-medium text-gray-700">クライアントメールアドレス</label>
                        <input type="email" id="client-email" name="clientEmail" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="folder-name" class="block text-sm font-medium text-gray-700">フォルダ名</label>
                        <input type="text" id="folder-name" name="folderName" required
                               pattern="[a-zA-Z0-9-_]+"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                               placeholder="英数字、ハイフン、アンダースコアのみ">
                        <p class="mt-1 text-xs text-gray-500">英数字、ハイフン、アンダースコアのみ使用可能です</p>
                    </div>
                    <div>
                        <label for="project-description" class="block text-sm font-medium text-gray-700">説明（任意）</label>
                        <textarea id="project-description" name="description" rows="3"
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeCreateModal()"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                            キャンセル
                        </button>
                        <button type="submit"
                                class="px-4 py-2 text-sm font-medium text-white bg-secondary border border-transparent rounded-md hover:bg-green-700">
                            作成
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ログイン情報表示モーダル -->
    <div id="login-info-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">プロジェクトが正常に作成されました</h3>
                <p class="text-sm text-gray-600 mb-4">以下のログイン情報をクライアントにお送りください。</p>
                
                <div class="bg-gray-50 p-4 rounded-md mb-4">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">クライアントログイン情報</h4>
                    <div class="space-y-2 text-sm">
                        <div>
                            <span class="font-medium">プロジェクトID:</span>
                            <span id="display-project-id" class="ml-2 font-mono bg-white px-2 py-1 rounded border"></span>
                        </div>
                        <div>
                            <span class="font-medium">パスワード:</span>
                            <span id="display-password" class="ml-2 font-mono bg-white px-2 py-1 rounded border"></span>
                        </div>
                        <div>
                            <span class="font-medium">フォルダ名:</span>
                            <span id="display-folder-name" class="ml-2 font-mono bg-white px-2 py-1 rounded border"></span>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                    <h4 class="text-sm font-medium text-blue-800 mb-2">メール送信</h4>
                    <div class="space-y-2">
                        <div>
                            <span class="text-sm text-blue-700">送信先:</span>
                            <span id="display-email" class="ml-2 text-sm font-medium text-blue-900"></span>
                        </div>
                        <button onclick="sendLoginEmail()" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            ログイン情報をメール送信
                        </button>
                    </div>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">重要</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>このパスワードは一度しか表示されません。必ずログイン情報をメール送信するか、コピーしてクライアントにお送りください。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button onclick="closeLoginInfoModal()"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary border border-transparent rounded-md hover:bg-blue-700">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- プロジェクト詳細・編集モーダル -->
    <div id="project-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">プロジェクト詳細・編集</h3>
                <form id="project-detail-form" class="space-y-4">
                    <input type="hidden" id="edit-project-id" name="projectId">
                    <div>
                        <label for="edit-project-name" class="block text-sm font-medium text-gray-700">プロジェクト名</label>
                        <input type="text" id="edit-project-name" name="projectName" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="edit-client-name" class="block text-sm font-medium text-gray-700">クライアント名</label>
                        <input type="text" id="edit-client-name" name="clientName" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="edit-client-email" class="block text-sm font-medium text-gray-700">クライアントメールアドレス</label>
                        <input type="email" id="edit-client-email" name="clientEmail" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="edit-folder-name" class="block text-sm font-medium text-gray-700">フォルダ名</label>
                        <input type="text" id="edit-folder-name" name="folderName" required
                               pattern="[a-zA-Z0-9-_]+"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="edit-project-description" class="block text-sm font-medium text-gray-700">説明</label>
                        <textarea id="edit-project-description" name="description" rows="3"
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"></textarea>
                    </div>
                    <div>
                        <label for="edit-project-status" class="block text-sm font-medium text-gray-700">ステータス</label>
                        <select id="edit-project-status" name="status"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                            <option value="draft">下書き</option>
                            <option value="active">公開中</option>
                            <option value="ended">終了</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeProjectDetailModal()"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">
                            キャンセル
                        </button>
                        <button type="submit"
                                class="px-4 py-2 text-sm font-medium text-white bg-primary border border-transparent rounded-md hover:bg-blue-700">
                            更新
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../assets/js/components.js"></script>
    <script src="../assets/js/pagination.js"></script>
    <script>
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 認証チェック
            if (!Components.checkAdminAuth()) {
                return;
            }

            // ナビゲーションのレンダリング
            const app = document.getElementById('app');
            app.innerHTML = `
                ${Components.renderAdminNavigation('projects')}
                
                <!-- メインコンテンツ -->
                <div class="flex-1 p-8">
                    ${Components.renderPageTitle('プロジェクト管理', 'すべてのキャンペーンプロジェクトを管理できます')}
                    
                    <!-- 新規プロジェクト作成ボタン -->
                    <div class="mb-6">
                        ${Components.renderButton('新規プロジェクト作成', 'secondary', 'md', 'openCreateModal()', false, '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>')}
                    </div>

                    <!-- 検索・フィルター -->
                    <div class="bg-white shadow rounded-lg mb-6">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">検索・フィルター</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label for="search-project-name" class="block text-sm font-medium text-gray-700">プロジェクト名</label>
                                    <input type="text" id="search-project-name" placeholder="プロジェクト名で検索"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label for="search-client-name" class="block text-sm font-medium text-gray-700">クライアント名</label>
                                    <input type="text" id="search-client-name" placeholder="クライアント名で検索"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label for="filter-date-from" class="block text-sm font-medium text-gray-700">作成日（開始）</label>
                                    <input type="date" id="filter-date-from"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label for="filter-date-to" class="block text-sm font-medium text-gray-700">作成日（終了）</label>
                                    <input type="date" id="filter-date-to"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button onclick="applyFilters()"
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    検索
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- プロジェクト一覧 -->
                    <div id="projects-container">
                        <!-- プロジェクト一覧はJavaScriptで動的に生成 -->
                    </div>

                    <!-- ページネーション -->
                    <div id="pagination-container" class="mt-6">
                        <!-- ページネーションはJavaScriptで動的に生成 -->
                    </div>
                </div>
            `;

            // フォームイベントリスナーを設定
            document.getElementById('create-project-form').addEventListener('submit', handleCreateProject);
            document.getElementById('project-detail-form').addEventListener('submit', handleUpdateProject);

            // 検索フィールドのイベントリスナーを設定
            document.getElementById('search-project-name').addEventListener('input', applyFilters);
            document.getElementById('search-client-name').addEventListener('input', applyFilters);
            document.getElementById('filter-date-from').addEventListener('change', applyFilters);
            document.getElementById('filter-date-to').addEventListener('change', applyFilters);

            // プロジェクト一覧を読み込み
            loadProjects();
        });

        // モーダル制御関数
        function openCreateModal() {
            document.getElementById('create-project-modal').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('create-project-modal').classList.add('hidden');
            document.getElementById('create-project-form').reset();
        }

        function closeLoginInfoModal() {
            document.getElementById('login-info-modal').classList.add('hidden');
        }

        function closeProjectDetailModal() {
            document.getElementById('project-detail-modal').classList.add('hidden');
        }

        // プロジェクト作成処理
        function handleCreateProject(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const projectName = formData.get('projectName');
            const clientName = formData.get('clientName');
            const clientEmail = formData.get('clientEmail');
            const folderName = formData.get('folderName');
            const description = formData.get('description');

            // フォルダ名のバリデーション
            if (!/^[a-zA-Z0-9-_]+$/.test(folderName)) {
                alert('フォルダ名は英数字、ハイフン、アンダースコアのみ使用可能です。');
                return;
            }

            // プロジェクトデータを作成
            const projectId = generateProjectId(clientName);
            const password = generatePassword(8);
            
            const projectData = {
                id: projectId,
                name: projectName,
                clientName: clientName,
                clientEmail: clientEmail,
                folderName: folderName,
                description: description || '',
                createdAt: new Date().toISOString(),
                status: 'active',
                password: password,
                clientUser: {
                    username: clientName,
                    email: clientEmail,
                    role: 'client',
                    projectId: projectId
                }
            };

            // プロジェクトを保存
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            projects.push(projectData);
            localStorage.setItem('projects', JSON.stringify(projects));

            // クライアントユーザーを保存
            const clientUsers = JSON.parse(localStorage.getItem('clientUsers') || '[]');
            clientUsers.push(projectData.clientUser);
            localStorage.setItem('clientUsers', JSON.stringify(clientUsers));

            // ログイン情報を表示
            showLoginInfo(projectData);

            // モーダルを閉じる
            closeCreateModal();

            // 一覧を再読み込み
            loadProjects();
        }

        // プロジェクト更新処理
        function handleUpdateProject(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const projectId = formData.get('projectId');
            const projectName = formData.get('projectName');
            const clientName = formData.get('clientName');
            const clientEmail = formData.get('clientEmail');
            const folderName = formData.get('folderName');
            const description = formData.get('description');
            const status = formData.get('status');

            // プロジェクトを更新
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const projectIndex = projects.findIndex(p => p.id === projectId);
            
            if (projectIndex !== -1) {
                projects[projectIndex].name = projectName;
                projects[projectIndex].clientName = clientName;
                projects[projectIndex].clientEmail = clientEmail;
                projects[projectIndex].folderName = folderName;
                projects[projectIndex].description = description;
                projects[projectIndex].status = status;

                localStorage.setItem('projects', JSON.stringify(projects));
                
                // クライアントユーザーも更新
                const clientUsers = JSON.parse(localStorage.getItem('clientUsers') || '[]');
                const userIndex = clientUsers.findIndex(u => u.projectId === projectId);
                if (userIndex !== -1) {
                    clientUsers[userIndex].username = clientName;
                    clientUsers[userIndex].email = clientEmail;
                    localStorage.setItem('clientUsers', JSON.stringify(clientUsers));
                }
            }

            closeProjectDetailModal();
            loadProjects();
        }

        // ログイン情報表示
        function showLoginInfo(projectData) {
            const loginUrl = `${window.location.origin}/client/login.html`;
            
            document.getElementById('display-project-id').textContent = projectData.id;
            document.getElementById('display-password').textContent = projectData.password;
            document.getElementById('display-folder-name').textContent = projectData.folderName;
            document.getElementById('display-email').textContent = projectData.clientEmail;
            
            // プロジェクトデータをモーダルに保存（メール送信用）
            document.getElementById('login-info-modal').setAttribute('data-project', JSON.stringify(projectData));
            
            document.getElementById('login-info-modal').classList.remove('hidden');
        }

        // メール送信機能
        function sendLoginEmail() {
            const projectData = JSON.parse(document.getElementById('login-info-modal').getAttribute('data-project'));
            
            // メール送信のシミュレーション（実際の実装ではサーバーサイドで処理）
            const emailContent = `
件名: レシートキャンペーンCMS ログイン情報

${projectData.clientName} 様

レシートキャンペーンCMSのログイン情報をお送りします。

【ログイン情報】
プロジェクトID: ${projectData.id}
パスワード: ${projectData.password}
フォルダ名: ${projectData.folderName}

【注意事項】
・このパスワードは一度しか表示されません
・ログイン後は必ずパスワードを変更してください
・ログイン情報は第三者に共有しないでください

ご不明な点がございましたら、お気軽にお問い合わせください。

レシートキャンペーンCMS管理チーム
            `;

            // メール送信のシミュレーション
            console.log('Sending email to:', projectData.clientEmail);
            console.log('Email content:', emailContent);
            
            // 実際の実装では、ここでサーバーサイドAPIを呼び出してメール送信
            alert(`ログイン情報を ${projectData.clientEmail} に送信しました。`);
        }

        // プロジェクト詳細・編集モーダルを開く
        function openProjectDetail(projectId) {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const project = projects.find(p => p.id === projectId);
            
            if (!project) return;

            // フォームに値を設定
            document.getElementById('edit-project-id').value = project.id;
            document.getElementById('edit-project-name').value = project.name;
            document.getElementById('edit-client-name').value = project.clientName;
            document.getElementById('edit-client-email').value = project.clientEmail || '';
            document.getElementById('edit-folder-name').value = project.folderName || '';
            document.getElementById('edit-project-description').value = project.description || '';
            document.getElementById('edit-project-status').value = project.status || 'active';

            document.getElementById('project-detail-modal').classList.remove('hidden');
        }

        // フィルター適用
        function applyFilters() {
            const projectNameFilter = document.getElementById('search-project-name').value.toLowerCase();
            const clientNameFilter = document.getElementById('search-client-name').value.toLowerCase();
            const dateFromFilter = document.getElementById('filter-date-from').value;
            const dateToFilter = document.getElementById('filter-date-to').value;
            
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const filteredProjects = projects.filter(project => {
                const matchesProjectName = project.name.toLowerCase().includes(projectNameFilter);
                const matchesClientName = project.clientName.toLowerCase().includes(clientNameFilter);
                
                let matchesDate = true;
                if (dateFromFilter || dateToFilter) {
                    const projectDate = new Date(project.createdAt);
                    const fromDate = dateFromFilter ? new Date(dateFromFilter) : null;
                    const toDate = dateToFilter ? new Date(dateToFilter) : null;
                    
                    if (fromDate && toDate) {
                        matchesDate = projectDate >= fromDate && projectDate <= toDate;
                    } else if (fromDate) {
                        matchesDate = projectDate >= fromDate;
                    } else if (toDate) {
                        matchesDate = projectDate <= toDate;
                    }
                }
                
                return matchesProjectName && matchesClientName && matchesDate;
            });

            // フィルター結果を表示
            displayProjects(filteredProjects);
        }

        // プロジェクト表示（フィルター用）
        function displayProjects(projects) {
            const container = document.getElementById('projects-container');
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">該当するプロジェクトがありません</h3>
                        <p class="mt-1 text-sm text-gray-500">検索条件を変更してください。</p>
                    </div>
                `;
                return;
            }

            let projectsHTML = `
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">プロジェクト一覧 (${projects.length}件)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('name')">
                                            プロジェクト名 <span id="sort-name" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('client')">
                                            クライアント名 <span id="sort-client" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('folder')">
                                            フォルダ名 <span id="sort-folder" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('status')">
                                            ステータス <span id="sort-status" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('date')">
                                            作成日 <span id="sort-date" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            操作
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
            `;

            projects.forEach(project => {
                const statusClass = project.status === 'active' ? 'bg-green-100 text-green-800' : 
                                  project.status === 'ended' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                const statusText = project.status === 'active' ? '公開中' : 
                                 project.status === 'ended' ? '終了' : '下書き';
                
                projectsHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${project.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${project.clientName}</div>
                            ${project.clientEmail ? `<div class="text-sm text-gray-500">${project.clientEmail}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900">${project.folderName || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(project.createdAt).toLocaleDateString('ja-JP')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="openProjectDetail('${project.id}')" class="text-primary hover:text-blue-700">
                                    詳細・編集
                                </button>
                                <button onclick="deleteProject('${project.id}')" class="text-red-600 hover:text-red-800">
                                    削除
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            projectsHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = projectsHTML;
        }

        // ソート機能
        let currentSortColumn = '';
        let currentSortDirection = 'asc';

        function sortTable(column) {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            
            // ソート方向を決定
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // ソートアイコンを更新
            updateSortIcons(column);

            // プロジェクトをソート
            const sortedProjects = projects.sort((a, b) => {
                let aValue, bValue;

                switch (column) {
                    case 'name':
                        aValue = a.name.toLowerCase();
                        bValue = b.name.toLowerCase();
                        break;
                    case 'client':
                        aValue = a.clientName.toLowerCase();
                        bValue = b.clientName.toLowerCase();
                        break;
                    case 'folder':
                        aValue = (a.folderName || '').toLowerCase();
                        bValue = (b.folderName || '').toLowerCase();
                        break;
                    case 'status':
                        aValue = a.status || '';
                        bValue = b.status || '';
                        break;
                    case 'date':
                        aValue = new Date(a.createdAt);
                        bValue = new Date(b.createdAt);
                        break;
                    default:
                        return 0;
                }

                if (aValue < bValue) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });

            // ソート結果を表示
            displayProjects(sortedProjects);
        }

        function updateSortIcons(activeColumn) {
            const columns = ['name', 'client', 'folder', 'status', 'date'];
            columns.forEach(col => {
                const icon = document.getElementById(`sort-${col}`);
                if (icon) {
                    if (col === activeColumn) {
                        icon.textContent = currentSortDirection === 'asc' ? '▲' : '▼';
                        icon.className = 'text-blue-600';
                    } else {
                        icon.textContent = '▼';
                        icon.className = 'text-gray-400';
                    }
                }
            });
        }

        // プロジェクト一覧を読み込み
        function loadProjects(page = 1) {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const itemsPerPage = 10;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProjects = projects.slice(startIndex, endIndex);
            const totalPages = Math.ceil(projects.length / itemsPerPage);

            const container = document.getElementById('projects-container');
            
            if (paginatedProjects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">プロジェクトがありません</h3>
                        <p class="mt-1 text-sm text-gray-500">新しいプロジェクトを作成してください。</p>
                    </div>
                `;
                return;
            }

            let projectsHTML = `
                <div class="bg-white shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">プロジェクト一覧 (${projects.length}件)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('name')">
                                            プロジェクト名 <span id="sort-name" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('client')">
                                            クライアント名 <span id="sort-client" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('folder')">
                                            フォルダ名 <span id="sort-folder" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('status')">
                                            ステータス <span id="sort-status" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTable('date')">
                                            作成日 <span id="sort-date" class="text-gray-400">▼</span>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            操作
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
            `;

            paginatedProjects.forEach(project => {
                const statusClass = project.status === 'active' ? 'bg-green-100 text-green-800' : 
                                  project.status === 'ended' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                const statusText = project.status === 'active' ? '公開中' : 
                                 project.status === 'ended' ? '終了' : '下書き';
                
                projectsHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${project.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${project.clientName}</div>
                            ${project.clientEmail ? `<div class="text-sm text-gray-500">${project.clientEmail}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900">${project.folderName || '-'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(project.createdAt).toLocaleDateString('ja-JP')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="openProjectDetail('${project.id}')" class="text-primary hover:text-blue-700">
                                    詳細・編集
                                </button>
                                <button onclick="deleteProject('${project.id}')" class="text-red-600 hover:text-red-800">
                                    削除
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            projectsHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = projectsHTML;

            // ページネーションを表示
            if (totalPages > 1) {
                Pagination.render('pagination-container', page, totalPages, (newPage) => {
                    loadProjects(newPage);
                });
            } else {
                document.getElementById('pagination-container').innerHTML = '';
            }
        }

        // プロジェクトID生成
        function generateProjectId(clientName) {
            const clientId = clientName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${clientId}${randomNum}`;
        }

        // パスワード生成
        function generatePassword(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // プロジェクト削除
        function deleteProject(projectId) {
            if (!confirm('このプロジェクトを削除しますか？この操作は取り消せません。')) {
                return;
            }

            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            const filteredProjects = projects.filter(p => p.id !== projectId);
            localStorage.setItem('projects', JSON.stringify(filteredProjects));

            // クライアントユーザーも削除
            const clientUsers = JSON.parse(localStorage.getItem('clientUsers') || '[]');
            const filteredClientUsers = clientUsers.filter(u => u.projectId !== projectId);
            localStorage.setItem('clientUsers', JSON.stringify(filteredClientUsers));

            loadProjects();
        }

        // グローバルログアウト関数
        function logout() {
            Components.logout();
        }
    </script>
</body>
</html> 